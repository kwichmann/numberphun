<!DOCTYPE html>
<html>
	<head>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/p5.min.js"></script>
	
		<script>
			var size;
			var pile;
			var d;
			
			function setup() {
				createCanvas(800, 800);
				
				size = 40;
				pile = new Array(size)
				d = width / size;
						
				for (var i = 0; i < size; i++) {
					pile[i] = [];
					for (var j = 0; j < size; j++) {
						pile[i].push(0);
					}
				}
				pile[size / 2][size / 2] = 40000;
				noStroke();
			}
			
			function draw() {
				build(pile);
				pile = topple(pile);
			}
			
			function build(arr) {
				for (var i = 0; i < size; i++) {
					for (var j = 0; j < size; j++) {
						fill(255);
						var num = arr[i][j]
						if (num == 0) {
							fill(0);
						}
						if (num == 1) {
							fill(0, 0, 255);
						}
						if (num == 2) {
							fill(0, 255, 0);
						}
						if (num == 3) {
							fill(255, 0, 0);
						}
						rect(i * d, j * d, d, d);
					}
				}
			}
			
			
			function topple(arr) {
				var new_arr = arr.map(function(arr) {return arr.slice();});
				
				for (var i = 0; i < size; i++) {
					for (var j = 0; j < size; j++) {
						if (arr[i][j] >= 4) {
							new_arr[i][j] -= 4;
							if (i > 0) {
								new_arr[i - 1][j] += 1;
							}
							if (i < size - 1) {
								new_arr[i + 1][j] += 1;
							}
							if (j > 0) {
								new_arr[i][j + 1] += 1;
							}
							if (j < size - 1) {
								new_arr[i][j - 1] += 1;
							}
						}
					}
				}
				return new_arr;
			}
		</script>
	</head>
	
	<body>
	</body>
</html>